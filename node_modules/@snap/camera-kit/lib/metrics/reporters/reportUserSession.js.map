{"version":3,"file":"reportUserSession.js","sourceRoot":"","sources":["../../../src/metrics/reporters/reportUserSession.ts"],"names":[],"mappings":"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","sourcesContent":["import { Injectable } from \"../../dependency-injection/Injectable\";\nimport { TypedCustomEvent } from \"../../events/TypedCustomEvent\";\nimport { DailySessionBucket } from \"../../generated-proto/blizzard/cameraKitEvents\";\nimport { IndexedDBPersistence } from \"../../persistence/IndexedDBPersistence\";\nimport { MakeTaggedBusinessEvent } from \"../businessEventsReporter\";\nimport { MetricsEventTarget, metricsEventTargetFactory } from \"../metricsEventTarget\";\n\ninterface UserSessionInfo {\n    mostRecentSessionStartDate: Date;\n    dailySessionBucket: DailySessionBucket;\n}\n\n/**\n * The Session metric reports each user session.\n */\nexport type Session = MakeTaggedBusinessEvent<\"session\">;\n\n/**\n * @internal\n */\nexport const reportUserSession = Injectable(\n    \"reportUserSession\",\n    [metricsEventTargetFactory.token] as const,\n    async (metricsEventTarget: MetricsEventTarget): Promise<void> => {\n        const userSessionKey = \"userSessionInfo\";\n        const db = new IndexedDBPersistence<UserSessionInfo>({ databaseName: \"SessionHistory\" });\n        // We standardize all user dates to PST as per our documentation:\n        // https://docs.google.com/document/d/1-kSzFWCWw9Qo3D08FR1_cqeHTsUtk9p3p3uOptzWDTY/\n        const date = new Date(\n            new Date().toLocaleDateString(\"en-US\", {\n                timeZone: \"America/Los_Angeles\",\n            })\n        );\n        const currentMonth = date.getMonth();\n        const currentDay = date.getDate();\n        const currentYear = date.getFullYear();\n\n        const userSessionInfo = await db.retrieve(userSessionKey);\n        const mostRecentSessionStartDate = userSessionInfo?.mostRecentSessionStartDate;\n        const dailySessionBucketMap = new Map<number, DailySessionBucket>([\n            [1, DailySessionBucket.ONE_SESSION],\n            [2, DailySessionBucket.TWO_SESSION],\n            [3, DailySessionBucket.THREE_SESSION],\n            [4, DailySessionBucket.FOUR_SESSION],\n            [5, DailySessionBucket.FIVE_SESSION],\n            [6, DailySessionBucket.SIX_SESSION],\n            [7, DailySessionBucket.SEVEN_SESSION],\n            [8, DailySessionBucket.EIGHT_SESSION],\n            [9, DailySessionBucket.NINE_SESSION],\n        ]);\n        let dailySessionBucket = userSessionInfo?.dailySessionBucket ?? DailySessionBucket.NO_SESSION_BUCKET;\n        let isFirstWithinMonth = false;\n        if (\n            mostRecentSessionStartDate &&\n            mostRecentSessionStartDate.getMonth() === currentMonth &&\n            mostRecentSessionStartDate.getDate() === currentDay &&\n            mostRecentSessionStartDate.getFullYear() === currentYear\n        ) {\n            dailySessionBucket =\n                dailySessionBucketMap.get(dailySessionBucket + 1) ?? DailySessionBucket.TEN_OR_MORE_SESSION;\n            await db.remove(userSessionKey);\n            await db.store(userSessionKey, {\n                mostRecentSessionStartDate: date,\n                dailySessionBucket,\n            });\n        } else {\n            isFirstWithinMonth = !mostRecentSessionStartDate || mostRecentSessionStartDate.getMonth() !== currentMonth;\n            await db.remove(userSessionKey);\n            await db.store(userSessionKey, {\n                mostRecentSessionStartDate: date,\n                dailySessionBucket: (dailySessionBucket = DailySessionBucket.ONE_SESSION),\n            });\n        }\n        const session: Session = {\n            name: \"session\",\n            dailySessionBucket,\n            isFirstWithinMonth,\n            month: currentMonth + 1, // Date.getMonth() is zero-based so we need to add 1\n            day: currentDay,\n            year: currentYear,\n        };\n        metricsEventTarget.dispatchEvent(new TypedCustomEvent(\"session\", session));\n    }\n);\n"]}